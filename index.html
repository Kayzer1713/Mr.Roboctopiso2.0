<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="stylebof.css">
</head>

<body>
  <div id="map"></div>
  <div id="info-box"></div>

  <script type="text/javascript">
    // initialisation des variables
    var maMap;
    var cheminJson = "https://api.myjson.com/bins/brvit";
    var cheminIcon = "sources/film-reel.png";
    var markers = [];
    var mapOptions = {  
      zoom: 10,
      //minZoom: 11,
      center: {
        lat: -25.363882,
        lng: 131.044922
      },
      // center: {
      //   lat: 48.866667,
      //   lng: 2.333333
      // },
      disableDefaultUI: true
    };

    // initialisation de la map
    function initMap() {

      maMap = new google.maps.Map(document.getElementById("map"), mapOptions);

      var fenetreInfo = new google.maps.InfoWindow();

      var testMarker = new google.maps.Marker({
        position: {
          lat: -25.363882,
          lng: 131.044922
        },
        icon: cheminIcon,
        title: "bifleMole!",
        map: maMap
      });

      var testMarker2 = new google.maps.Marker({
        position: {
          lat: -25.383882,
          lng: 131.064922
        },
        icon: cheminIcon,
        title: "kamoulox!",
        map: maMap
      });
      addListenerToMmarker(testMarker2, "bloblbolbolbo");
      addListenerToMmarker(testMarker, "blablalbalblabla");
      // lecture et parçage du json
      $.getJSON(cheminJson, function(data) {
        // création de tout les markers depuis le json
        $.each(data.features, function(index, cinema) {
          // création de l'objet latlng pour la position du Marker
          var latLng = new google.maps.LatLng(cinema.properties.lat, cinema.geometry.lng);
          // création du Marker
          markers[index] = new google.maps.Marker({
            position: {
              lat: latLng.lat(),
              lng: latLng.lng()
            },
            map: maMap,
            icon: cheminIcon,
            title: cinema.properties.enseigne
          });

          var content = "<p>Nom: " + cinema.properties.enseigne + "</p>" +
            "<p>Adresse: " + cinema.properties.adrnumvoie + "</p>" +
            "<p>Ville: " + cinema.properties.ville + "</p>";

          // ajout des listeners pour le marker
          addListenerToMmarker(markers[index], content);

        }); // fin de la création des markers

      }); // fin du paçage du json

      function addListenerToMmarker(marker, text) {
        // affichage du nom du marker dans l'info-box
        marker.addListener('mouseover', function() {
          document.getElementById('info-box').textContent =  marker.getTitle();
        });
        // affichage du nom du marker dans l'info-box
        marker.addListener('mouseout', function() {
          document.getElementById('info-box').textContent =  '';
        });
        // affichage de la fenetreInfo
        marker.addListener('click', function() {
          maMap.panTo(new google.maps.LatLng(marker.getPosition().lat(), marker.getPosition().lng())); // change le centre de la map
          smoothZoom(maMap, 16, maMap.getZoom());
          fenetreInfo.setContent(text);
          fenetreInfo.open(map, marker);
        });
      }
    }

    // listener pour fermet l'infowindow au click extérieur
    google.maps.event.addListener(map, "click", function(event) {
      fenetreInfo.close();
    });

    // fonction pour gérer le zoom sur les markers
    function smoothZoom(map, max, cnt) {
      if (cnt >= max) {
        return;
      } else {
        z = google.maps.event.addListener(map, 'zoom_changed', function(event) {
          google.maps.event.removeListener(z);
          smoothZoom(map, max, cnt + 1);
        });
        setTimeout(function() {
          map.setZoom(cnt)
        }, 70);
      }
    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADQEU2wl1189-XtBtihLzSy4OnpKS7yY0&callback=initMap"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</body>

</html>
